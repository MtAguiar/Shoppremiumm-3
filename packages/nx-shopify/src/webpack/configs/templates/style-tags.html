<% var liquidTemplates = htmlWebpackPlugin.options.liquidTemplates; %>
<% var liquidLayouts = htmlWebpackPlugin.options.liquidLayouts; %>
<% var extractedMediaQueries = { css: [], js: [] }; %>
<% if (htmlWebpackPlugin.files.extracted) { %>
  <% extractedMediaQueries.css = htmlWebpackPlugin.files.extracted.css || [] %>
  <% extractedMediaQueries.js = htmlWebpackPlugin.files.extracted.js || [] %>
<% } %>
<% var getExtractedStyles = htmlWebpackPlugin.options.getExtractedStyles; %>

<% for (var cssFile of htmlWebpackPlugin.files.css) { %>
    <% var basename = cssFile.split('/').reverse()[0]; %>
    <% var chunkName = basename.replace('.scss', '').replace('.css', '').replace('.styleLiquid', ''); %>
    <% var isLiquidStyle = /.liquidStyle.css$/.test(basename) %>
    <% if (htmlWebpackPlugin.options.isDevServer === true && !basename.includes('.styleLiquid')) { %>
      <% var src = cssFile %>
    <% } else { %>
      <% var src = `{{ '${basename}' | asset_url }}` %>
    <% } %>
    <% if (typeof liquidTemplates[chunkName] !== 'undefined') { %>
      <% var chunkTemplate = liquidTemplates[chunkName] %>
      <% var templateName = chunkName.split('.').slice(0, -1).join('.') %>
      <% if (templateName.startsWith('customers.')) { %>
        {%- if template == 'customers/<%= templateName.split('.').slice(1).join('.') %>' -%}
          <link rel="stylesheet" href="<%= src %>" rel="stylesheet">
          <% for (var extractedCss of getExtractedStyles(chunkName, extractedMediaQueries.css)) { %>
            <link rel="stylesheet" href="<%= extractedCss.file %>" media="<%= extractedCss.query %>">
          <% } %>
        {%- else -%}
          <link rel="prefetch" href="<%= src %>" as="style">
          <% for (var extractedCss of getExtractedStyles(chunkName, extractedMediaQueries.css)) { %>
            <link rel="prefetch" href="<%= extractedCss.file %>" as="style">
          <% } %>
        {%- endif -%}
      <% } else { %>
        {%- if template == '<%= templateName %>' -%}
          <link rel="stylesheet" href="<%= src %>" rel="stylesheet">
          <% for (var extractedCss of getExtractedStyles(chunkName, extractedMediaQueries.css)) { %>
            <link rel="stylesheet" href="<%= extractedCss.file %>" media="<%= extractedCss.query %>">
          <% } %>
        {%- else -%}
          <link rel="prefetch" href="<%= src %>" as="style">
          <% for (var extractedCss of getExtractedStyles(chunkName, extractedMediaQueries.css)) { %>
            <link rel="prefetch" href="<%= extractedCss.file %>" as="style">
          <% } %>
        {%- endif -%}
      <% } %>
    <% } else if (typeof liquidLayouts[chunkName] !== 'undefined') { %>
      <% var layoutName = chunkName.split('.').slice(0, -1).join('.') %>
      {%- if layout == '<%= layoutName %>' -%}
        <link rel="stylesheet" href="<%= src %>" rel="stylesheet">
        <% for (var extractedCss of getExtractedStyles(chunkName, extractedMediaQueries.css)) { %>
          <link rel="stylesheet" href="<%= extractedCss.file %>" media="<%= extractedCss.query %>">
        <% } %>
      {%- else -%}
        <link rel="prefetch" href="<%= src %>" as="style">
        <% for (var extractedCss of getExtractedStyles(chunkName, extractedMediaQueries.css)) { %>
          <link rel="prefetch" href="<%= extractedCss.file %>" as="style">
        <% } %>
      {%- endif -%}
    <% } else if (chunkName.split('%40').length > 1) { %>
      <% var pages = chunkName.split('%40') %>
      <% var conditions = [] %>
      <% pages.forEach(function(page) { %>
        <% var pageTemplate = liquidTemplates[page] %>
        <% if (typeof pageTemplate !== 'undefined') { %>
          <% var pageTemplateName = page.split('.').slice(1).join('.'); %>
          <% if (pageTemplate.includes('customers/') || pageTemplate.includes('customers\\')) { %>
            <% conditions.push("template == 'customers/" + pageTemplateName + "'") %>
          <% } else { %>
            <% conditions.push("template == '" + pageTemplateName + "'") %>
          <% } %>
        <% } else if (typeof liquidLayouts[page] !== 'undefined') { %>
          <% conditions.push("layout == '" + page.split('.')[1] + "'") %>
        <% } %>
      <% }); %>
      {%- if <%= conditions.join(' or ') %> -%}
        <link rel="stylesheet" href="<%= decodeURIComponent(src) %>" rel="stylesheet">
        <% for (var extractedCss of getExtractedStyles(decodeURIComponent(chunkName), extractedMediaQueries.css)) { %>
          <link rel="stylesheet" href="<%= extractedCss.file %>" media="<%= extractedCss.query %>">
        <% } %>
      {%- else -%}
        <link rel="prefetch" href="<%= decodeURIComponent(src) %>" as="style">
        <% for (var extractedCss of getExtractedStyles(decodeURIComponent(chunkName), extractedMediaQueries.css)) { %>
          <link rel="prefetch" href="<%= extractedCss.file %>" as="style">
        <% } %>
      {%- endif -%}
    <% } else { %>
      <link rel="stylesheet" href="<%= src %>" rel="stylesheet">
      <% for (var extractedCss of getExtractedStyles(chunkName, extractedMediaQueries.css)) { %>
        <link rel="stylesheet" href="<%= extractedCss.file %>" media="<%= extractedCss.query %>">
      <% } %>
    <% } %>
  <% } %>
  